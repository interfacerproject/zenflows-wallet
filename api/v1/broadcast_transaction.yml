zenchain: 1.0
start: v1/broadcast_transaction_1_setup.zen
blocks:
  v1/broadcast_transaction_1_setup.zen:
    zenContent: |
      Rule caller restroom-mw

      Given I read the http request
      Given I have a 'string dictionary' named 'http_request'

      # keys
      Given I have a 'string dictionary' named 'post'

      # data
      Given I have a 'string dictionary' named 'request'

      # prepare query for zenflows
      When I pickup from path 'http_request.headers.zenflows-id'
      When I create the 'string dictionary' named 'variables'
      and I move the 'zenflows-id' to 'id' in 'variables'
      and I move 'variables' in 'post'

      # extract signature
      When I pickup from path 'http_request.headers.zenflows-sign'

      Then print the 'post'
      Then print the 'request'
      Then print the 'zenflows-sign'
    keysFile: v1/_keys_setup.keys
    next: v1/broadcast_transaction_2_verify.zen
  v1/broadcast_transaction_2_verify.zen:
    zenContent: |
      Rule caller restroom-mw
      Scenario 'eddsa': verify signature

      Given I have a endpoint named 'zenflows-endpoint'
      Given I connect to 'zenflows-endpoint' and pass it the content of 'post' and save the output into 'zenflows-result'
      Given I have a 'base58 dictionary' named 'zenflows-result'

      # data
      Given I have a 'eddsa signature' named 'zenflows-sign'
      Given I have a 'string dictionary' named 'request'

      # verify signature
      When I pickup a 'eddsa public key' from path 'zenflows-result.result.data'
      and I rename 'data' to 'sender'
      When I verify the 'request' has a eddsa signature in 'zenflows-sign' by 'sender'

      Then print the 'sender'
      Then print the 'amount' from 'request'
      Then print the 'planetmint transaction' from 'request'
      Then print the 'planetmint signatures' from 'request'
    keysFile: v1/_keys_zenflows_endpoint.keys
    next: v1/broadcast_transaction_3_broadcast.zen
  v1/broadcast_transaction_3_broadcast.zen:
    zenContent: |
      Rule caller restroom-mw
      Scenario 'eddsa': Public keys

      Given I have a planetmint endpoint named 'planetmint-endpoint'

      Given I have a 'string' named 'planetmint transaction'
      Given I have a 'string array' named 'planetmint signatures'
      Given I have a 'eddsa public key' named 'sender'

      Then print the 'planetmint transaction'
      Then print the 'planetmint signatures'
      Then print the 'sender'

      Then I prepare the signed planetmint transaction of 'planetmint_transaction' from 'sender'
      Then ask planetmint to broadcast the 'signed_planetmint_transaction'
    keysFile: v1/_keys_planetmint_endpoint.keys
